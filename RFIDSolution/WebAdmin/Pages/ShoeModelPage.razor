<TableHeader>
    <HeaderContent>
        <button class="btn btn-light" @onclick="async () => { await loadData(); }"><span class="oi oi-reload mr-2 text-primary"></span>Refresh data</button>
    </HeaderContent>
    <FilterContent>
        <div class="row">
            <div class="col-md-4">
                <InputSearch TextChanged='async (text) => { filter.Keyword = text??""; await loadData(); }' PlaceHolder="Model's name"></InputSearch>
            </div>
        </div>
    </FilterContent>
</TableHeader>

@if (loading)
{
    <Loading></Loading>
}
else
{

    <div class="m-2 bg-white">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Model Id</th>
                    <th>Model name</th>
                    <th>Product count</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var model in shoeModels)
                {
                    @if (!model.IsEditing)
                    {
                        <tr class="hand">
                            <td class="wp-200">@model.Id</td>
                            <td>@model.Name</td>
                            <td class="wp-200">@model.ProductCount</td>
                            <td class="wp-75 p-0">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-icon" @onclick="() => model.IsEditing = true"><span class="oi oi-pencil text-warning"></span></button>
                                    <button type="button" class="btn btn-icon" @onclick="() => deleteModel(model)"><span class="oi oi-delete text-danger"></span></button>
                                </div>
                            </td>
                        </tr>
                    }
                    else
                    {
                        <tr class="new-row">
                            <td class="wp-200">@model.Id</td>
                            <td class="p-0"><input type="text" @bind-value="model.Name" class="form-control" /></td>
                            <td class="wp-200">0</td>
                            <td class="wp-75 p-0">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-icon" @onclick="() => editModel(model)"><span class="oi oi-check text-success"></span></button>
                                    <button type="button" class="btn btn-icon" @onclick="async () => { model.IsEditing = false; await loadData(); }"><span class="oi oi-circle-x text-secondary"></span></button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                @if (addingItem)
                {
                    <tr class="new-row">
                        <td class="p-0 ps-3 wp-200"></td>
                        <td class="p-0"><input type="text" @bind-value="newShoeModel.Name" class="form-control" /></td>
                        <td class="p-0 ps-3 wp-200">0</td>
                        <td class="wp-75 p-0">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-icon" @onclick="addModel"><span class="oi oi-check text-success"></span></button>
                                <button type="button" class="btn btn-icon" @onclick="() => addingItem = false"><span class="oi oi-circle-x text-danger"></span></button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="1000">
                        <a class="hand" @onclick="() => { addingItem = !addingItem; }"><span class="@addClass"></span>@addText</a>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
}


@page "/shoemodels"
@using static RFIDSolution.Shared.Protos.ShoeModelProto
@inject ShoeModelProtoClient client
@inject DialogService _dialog
@code {
    [CascadingParameter] public IModalService Modal { get; set; }

    private bool loading = true;
    private bool addingItem = false;
    private string addText => !addingItem ? "ADD SHOE MODEL" : "CANCEL ADD";
    private string addClass => addingItem ? "oi oi-circle-x text-danger" : "oi oi-plus text-success";

    private ShoeModelRequest newShoeModel = new ShoeModelRequest();
    private ShoeModelResponse reply = new ShoeModelResponse();
    private ShoeModelFilter filter = new ShoeModelFilter();
    private List<ShoeModel> shoeModels => reply.Data.ToList();

    protected override async Task OnInitializedAsync()
    {
        MainLayout.Instance.PageTitle = "Shoe models";
        await loadData();
    }

    private async Task addModel()
    {
        if (string.IsNullOrEmpty(newShoeModel.Name))
        {
            await _dialog.ErrorAlert("Please input new model's name!");
            return;
        }

        if (!await _dialog.Confirm("Are you sure you want to add shoe model?")) return;

        var rspns = await client.PostAsync(newShoeModel);
        if (rspns.IsSuccess)
        {
            await _dialog.SuccessAlert("Model added!");
            newShoeModel = new ShoeModelRequest();
            await loadData();
        }
        else
        {
            await _dialog.SuccessAlert(rspns.Message);
        }
    }

    private async Task editModel(ShoeModel item)
    {
        if (string.IsNullOrEmpty(item.Name))
        {
            await _dialog.ErrorAlert("Please input new model's name!");
            return;
        }

        if (!await _dialog.Confirm("Are you sure you want to save changed?")) return;

        var req = new ShoeModelRequest();
        req.Id = item.Id;
        req.Name = item.Name;

        var rspns = await client.PutAsync(req);
        if (rspns.IsSuccess)
        {
            await _dialog.SuccessAlert("Model's name updated!");
            await loadData();
        }
        else
        {
            await _dialog.SuccessAlert(rspns.Message);
        }
    }

    private async Task deleteModel(ShoeModel item)
    {
        if (!await _dialog.Confirm("Are you sure you want to delete this shoe model?")) return;

        var req = new ShoeModelRequest();
        req.Id = item.Id;
        var rspns = await client.DeleteAsync(req);
        if (rspns.IsSuccess)
        {
            await _dialog.SuccessAlert("Model deleted!");
            await loadData();
        }
        else
        {
            await _dialog.SuccessAlert(rspns.Message);
        }
    }

    private async Task loadData()
    {
        loading = true;
        reply = await client.GetAsync(filter);
        loading = false;
    }
}
