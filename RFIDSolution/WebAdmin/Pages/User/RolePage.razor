<TableHeader>
    <HeaderContent>
        <button class="btn btn-light" @onclick="async () => { await loadData(); }"><span class="oi oi-reload mr-2 text-primary"></span>Refresh data</button>
    </HeaderContent>
    <FilterContent>
        <div class="row">
            <div class="col-md-4">
                <InputSearch TextChanged='async (text) => { keyword = text??""; await loadData(); }' PlaceHolder="Role's name"></InputSearch>
            </div>
        </div>
    </FilterContent>
</TableHeader>

@if (loading)
{
    <Loading></Loading>
}
else
{

    <div class="m-2 bg-white">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Role RoleId</th>
                    <th>Role name</th>
                    <th>User count</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var Role in roles)
                {
                    @if (!Role.IsEditing)
                    {
                        <tr class="hand">
                            <td class="wp-200">@Role.RoleId</td>
                            <td>@Role.Name</td>
                            <td class="wp-200">@Role.USER_COUNT</td>
                            <td class="wp-75 p-0">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-icon" @onclick="() => Role.IsEditing = true"><span class="oi oi-pencil text-warning"></span></button>
                                    <button type="button" class="btn btn-icon" @onclick="() => deleteModel(Role)"><span class="oi oi-delete text-danger"></span></button>
                                </div>
                            </td>
                        </tr>
                    }
                    else
                    {
                        <tr class="new-row">
                            <td class="wp-200">@Role.RoleId</td>
                            <td class="p-0"><input type="text" @bind-value="Role.Name" class="form-control" /></td>
                            <td class="wp-200">0</td>
                            <td class="wp-75 p-0">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-icon" @onclick="() => editModel(Role)"><span class="oi oi-check text-success"></span></button>
                                    <button type="button" class="btn btn-icon" @onclick="async () => { Role.IsEditing = false; await loadData(); }"><span class="oi oi-circle-x text-secondary"></span></button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                @if (addingItem)
                {
                    <tr class="new-row">
                        <td class="p-0 ps-3 wp-200"></td>
                        <td class="p-0"><input type="text" @bind-value="newModel.Name" class="form-control" /></td>
                        <td class="p-0 ps-3 wp-200">0</td>
                        <td class="wp-75 p-0">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-icon" @onclick="addModel"><span class="oi oi-check text-success"></span></button>
                                <button type="button" class="btn btn-icon" @onclick="() => addingItem = false"><span class="oi oi-circle-x text-danger"></span></button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="1000">
                        <a class="hand" @onclick="() => { addingItem = !addingItem; }"><span class="@addClass"></span>@addText</a>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
}

@attribute [Authorize]
@page "/roles"
@inject DialogService _dialog
@inject HttpClient _httpClient
@code {
    [CascadingParameter] public IModalService Modal { get; set; }

    private string baseUrl = "roles";
    private string keyword = "";
    private bool loading = true;
    private bool addingItem = false;
    private string addText => !addingItem ? "ADD NEW ROLE" : "CANCEL ADD";
    private string addClass => addingItem ? "oi oi-circle-x text-danger" : "oi oi-plus text-success";

    private List<RoleModel> roles = new List<RoleModel>();
    private RoleModel newModel = new RoleModel();

    protected override async Task OnInitializedAsync()
    {
        MainLayout.Instance.PageTitle = "System roles";
        await loadData();
    }

    private async Task addModel()
    {
        if (string.IsNullOrEmpty(newModel.Name))
        {
            await _dialog.ErrorAlert("Please input new role's name!");
            return;
        }

        if (!await _dialog.Confirm("Are you sure you want to add role?")) return;

        var req = await _httpClient.PostAsJsonAsync<RoleModel>($"{baseUrl}", newModel);
        var rspns = await req.Content.ReadFromJsonAsync<ResponseModel<object>>();
        if (rspns.IsSuccess)
        {
            await _dialog.SuccessAlert("Role added!");
            newModel = new RoleModel();
            await loadData();
        }
        else
        {
            await _dialog.ErrorAlert(rspns.Message);
        }
    }

    private async Task editModel(RoleModel item)
    {
        if (string.IsNullOrEmpty(item.Name))
        {
            await _dialog.ErrorAlert("Please input new role's name!");
            return;
        }

        if (!await _dialog.Confirm("Are you sure you want to save changes?")) return;

        var httpReq = await _httpClient.PutAsJsonAsync($"{baseUrl}/{item.RoleId}", item);
        var rspns = await httpReq.Content.ReadFromJsonAsync<ResponseModel<object>>();

        if (rspns.IsSuccess)
        {
            await _dialog.SuccessAlert("Role's name updated!");
            await loadData();
        }
        else
        {
            await _dialog.ErrorAlert(rspns.Message);
        }
    }

    private async Task deleteModel(RoleModel item)
    {
        if (!await _dialog.Confirm("Are you sure you want to delete this role?")) return;

        var httpReq = await _httpClient.DeleteAsync($"{baseUrl}/{item.RoleId}");
        var rspns = await httpReq.Content.ReadFromJsonAsync<ResponseModel<object>>();
        if (rspns.IsSuccess)
        {
            await _dialog.SuccessAlert("Role deleted!");
            await loadData();
        }
        else
        {
            await _dialog.ErrorAlert(rspns.Message);
        }
    }

    private async Task loadData()
    {
        loading = true;
        var rspns = await _httpClient.GetFromJsonAsync<ResponseModel<List<RoleModel>>>($"{baseUrl}?keyword={keyword}");
        if (rspns.IsSuccess)
        {
            roles = rspns.Result;
        }
        else
        {
            await _dialog.ErrorAlert(rspns.Message);
        }
        loading = false;
    }
}
